name: CI & Deploy to Render

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci:
    name: CI (lint & build)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      
      - name: Clean install dependencies
        env:
          # Force npm to install optional dependencies (native binaries)
          npm_config_optional: "true"
        run: |
          rm -rf node_modules
          npm cache clean --force
          # Không dùng npm ci vì nó lock vào exact versions trong lockfile (có thể là Windows binaries)
          # Dùng npm install với --no-optional=false để đảm bảo optional dependencies được cài
          npm install --no-optional=false
          
      - name: Force install/rebuild Linux native binaries
        run: |
          # Xóa platform-specific binaries cũ (nếu có Windows binaries từ lockfile)
          rm -rf node_modules/lightningcss/node_modules/lightningcss-win32-* || true
          # Force install Linux binary
          npm install lightningcss-linux-x64-gnu@1.31.1 --save-optional --force || true
          # Rebuild để đảm bảo native module được link đúng
          npm rebuild lightningcss || true
          # Verify installation
          if [ -f "node_modules/lightningcss/node_modules/lightningcss-linux-x64-gnu/lightningcss.linux-x64-gnu.node" ]; then
            echo "✅ lightningcss-linux-x64-gnu.node found"
          elif [ -d "node_modules/lightningcss/node_modules/lightningcss-linux-x64-gnu" ]; then
            echo "✅ lightningcss-linux-x64-gnu directory found"
            ls -la node_modules/lightningcss/node_modules/lightningcss-linux-x64-gnu/
          else
            echo "⚠️  lightningcss-linux-x64-gnu not found, checking lightningcss structure..."
            ls -la node_modules/lightningcss/ || true
            ls -la node_modules/lightningcss/node_modules/ || true
          fi

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  deploy:
    name: Deploy to Render
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Render deploy hook
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "RENDER_DEPLOY_HOOK_URL is not set"; exit 1;
          fi
          echo "Triggering Render deploy..."
          curl -X POST "$RENDER_DEPLOY_HOOK_URL"

